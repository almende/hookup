<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hookup client demo</title>
  <script src="../dist/peer/hookup.js"></script>
  <style>
    form {
      margin: 1em 0;
    }
    div.log.info {
      color: dodgerblue;
    }
    div.log.error {
      color: orangered;
    }
  </style>
</head>
<body>
  See developer console (F12)...

  <form id="register">
    Set an id:
    <input type="text" value="peer1" id="from" />
    <input type="submit" value="Register"/>
  </form>
  <form id="send">
    Send a message to:
    <input type="text" value="peer2" id="to" />
    message:
    <input type="text" value="hello there!" id="message" />
    <input type="submit" value="Send" />
  </form>
  <div id="messages"></div>

  <script>
    "use strict";

    console.info('To enable debugging, enter hookupDebug.enable(\'hookup:*\') in this console, then refresh the page');

    let peer = null;

    let register = document.querySelector('#register');
    let send = document.querySelector('#send');
    let from = document.querySelector('#from');
    let to = document.querySelector('#to');
    let message = document.querySelector('#message');
    let messages = document.querySelector('#messages');

    function argumentsToArray (args) {
      let array = [];
      for (var i = 0; i < args.length; i++) {
        array.push(args[i]);
      }
      return array;
    }

    let DOMConsole = {
      log: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      },

      info: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.className = 'log info';
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      },

      error: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.className = 'log error';
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      }
    };


    window.addEventListener('load', function load() {

      register.onsubmit = function (event) {
        event.preventDefault();

        // close previous peer (if any)
        if (peer) {
          peer.close();
        }

        let peerId = from.value;
        peer = hookup.createPeer(peerId);

        peer.on('connect', () => {
          DOMConsole.info('connected');
        });
        peer.on('error', err => {
          console.error(err);
          DOMConsole.error(err);
        });
        peer.on('message', (envelope) => {
          DOMConsole.log('received message from', envelope.from, ':', envelope.message);
        });
      };

      send.onsubmit = function (event) {
        event.preventDefault();

        DOMConsole.log('sending message to', to.value, ':', message.value);

        peer.send(to.value, message.value)
            .then(function () {
              DOMConsole.log('message sent');
            })
            .catch(function (err) {
              console.error(err);
              DOMConsole.error(err);
            });
      };
    });
  </script>

</body>
</html>