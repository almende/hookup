<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hookup client demo</title>
  <script src="http://hookitup.herokuapp.com/hookup.js"></script>
  <style>
    form {
      margin: 1em 0;
    }
    input[type=text] {
      padding: 5px;
      border: 1px solid #b5b5b5;
    }
    input[type=submit] {
      padding: 5px;
    }
    input.peer {
      width: 80px;
    }
    div.log.info {
      color: dodgerblue;
    }
    div.log.error {
      color: orangered;
    }
  </style>
</head>
<body>
  See developer console (F12)...

  <form id="register">
    Set an id:
    <input type="text" class="peer" value="peer1" id="from" />
    <input type="submit" value="Register"/>
  </form>
  <form id="send">
    Send message:
    <input type="text" value="hello there!" id="message" />
    to:
    <input type="text" class="peer" value="peer2" id="to" />
    <input type="submit" value="Send" />
  </form>
  <div id="messages"></div>

  <script>
    "use strict";

    console.info('To enable debugging, enter hookupDebug.enable(\'hookup:*\') in this console, then refresh the page');

    let peer = null;

    let register = document.querySelector('#register');
    let send = document.querySelector('#send');
    let from = document.querySelector('#from');
    let to = document.querySelector('#to');
    let message = document.querySelector('#message');
    let messages = document.querySelector('#messages');

    function argumentsToArray (args) {
      let array = [];
      for (var i = 0; i < args.length; i++) {
        array.push(args[i]);
      }
      return array;
    }

    let DOMConsole = {
      log: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      },

      info: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.className = 'log info';
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      },

      error: function () {
        let text = argumentsToArray(arguments).join(' ');

        var message = document.createElement('div');
        message.className = 'log error';
        message.appendChild(document.createTextNode(text));
        messages.appendChild(message);
      }
    };

    window.addEventListener('load', function load() {
      /**
       * Register our peer with an id at the broker
       * @param event
       */
      register.onsubmit = function (event) {
        event.preventDefault();

        // close previous peer (if any)
        if (peer) {
          peer.close();
        }

        let peerId = from.value;
        peer = hookup.createPeer(peerId);

        peer.on('register', () => {
          DOMConsole.info('Registered as', peerId);
        });
        peer.on('error', err => {
          console.error(err);
          DOMConsole.error(err);
        });
        peer.on('message', (envelope) => {
          DOMConsole.log('Received message from', envelope.from, ':', envelope.message);
        });
      };

      /**
       * Send a message to another peer
       * @param event
       */
      send.onsubmit = function (event) {
        event.preventDefault();

        if (peer) {
          var text = message.value;
          message.value = '';
          DOMConsole.log('Sending message to', to.value, ':', text);

          peer.send(to.value, text)
              .then(function () {
                DOMConsole.log('Message sent');
              })
              .catch(function (err) {
                console.error(err);
                DOMConsole.error(err);
              });
        }
        else {
          DOMConsole.error('Cannot send a message, register yourself first...');
        }
      };
    });
  </script>

</body>
</html>